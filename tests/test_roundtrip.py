#!/usr/bin/env python3"""Тест шифрования-дешифрования (round-trip) для всех режимовSprint 2: ECB, CBC, CFB, OFB, CTR"""import osimport subprocessimport tempfileimport sysdef run_command(cmd):    """Запускает команду и возвращает результат"""    result = subprocess.run(        cmd, shell=True, capture_output=True, text=True    )    return result.returncode, result.stdout, result.stderrdef test_mode_roundtrip(mode, data_size=225, need_padding=True):    """Тест round-trip для конкретного режима"""    print(f"\n--- Тест режима: {mode.upper()} ---")        # Создаем тестовый файл    with tempfile.NamedTemporaryFile(mode='wb', delete=False) as f:        test_data = os.urandom(data_size)        if mode == 'cfb' and need_padding:            # Для CFB делаем данные кратными 16 байтам            test_data = os.urandom(160)            print(f"1. Создан тестовый файл для CFB: {len(test_data)} байт (кратно 16)")        else:            print(f"1. Создан тестовый файл: {len(test_data)} байт")        f.write(test_data)        input_file = f.name        encrypted_file = input_file + '.enc'    decrypted_file = input_file + '.dec'    key = "00112233445566778899aabbccddeeff"        try:        # 2. Шифрование        print("2. Шифруем...")                # НОВЫЙ ФОРМАТ: Добавляем 'encrypt' как субкоманду        if mode in ['ecb', 'cbc']:            # Для режимов с padding            cmd = (f"python cryptocore.py encrypt --algorithm aes --mode {mode} --encrypt "                   f"--key {key} --input {input_file} --output {encrypted_file}")        else:            # Для stream режимов            cmd = (f"python cryptocore.py encrypt --algorithm aes --mode {mode} --encrypt "                   f"--key {key} --input {input_file} --output {encrypted_file}")                returncode, stdout, stderr = run_command(cmd)                if returncode != 0:            print(f"Ошибка: {stderr}")            return False                # 3. Дешифрование        print("3. Дешифруем...")                if mode in ['ecb', 'cbc']:            # Для ECB не нужен IV            cmd = (f"python cryptocore.py encrypt --algorithm aes --mode {mode} --decrypt "                   f"--key {key} --input {encrypted_file} --output {decrypted_file}")        else:            # Для других режимов нужно извлечь IV из файла или использовать --iv            cmd = (f"python cryptocore.py encrypt --algorithm aes --mode {mode} --decrypt "                   f"--key {key} --input {encrypted_file} --output {decrypted_file}")            # Если ваш CLI поддерживает автоматическое извлечение IV из файла                returncode, stdout, stderr = run_command(cmd)                if returncode != 0:            print(f"Ошибка дешифрования: {stderr}")            return False                # 4. Сравнение        print("4. Сравниваем...")        with open(decrypted_file, 'rb') as f:            decrypted_data = f.read()                if test_data == decrypted_data:            print(f"5. Режим {mode.upper()}: [+] ПРОЙДЕН")            return True        else:            print(f"5. Режим {mode.upper()}: [-] НЕ ПРОЙДЕН")            print(f"   Размер исходных данных: {len(test_data)} байт")            print(f"   Размер расшифрованных данных: {len(decrypted_data)} байт")            return False        except Exception as e:        print(f"Исключение: {e}")        return False        finally:        # Очистка        for f in [input_file, encrypted_file, decrypted_file]:            if os.path.exists(f):                try:                    os.remove(f)                except:                    passdef test_cli_validation():    """Тест валидации CLI аргументов"""    print("\n=== Тест валидации CLI (Sprint 2) ===")        tests = [        {            'name': 'Нет обязательных аргументов',            'cmd': 'python cryptocore.py encrypt',            'should_fail': True        },        {            'name': 'Оба флага --encrypt и --decrypt',            'cmd': 'python cryptocore.py encrypt --algorithm aes --mode ecb --encrypt --decrypt --key 00 --input x --output y',            'should_fail': True        },        {            'name': 'Неподдерживаемый алгоритм',            'cmd': 'python cryptocore.py encrypt --algorithm des --mode ecb --encrypt --key 00 --input x --output y',            'should_fail': True        },        {            'name': 'Неподдерживаемый режим',            'cmd': 'python cryptocore.py encrypt --algorithm aes --mode xxx --encrypt --key 00 --input x --output y',            'should_fail': True        },        {            'name': 'Некорректный ключ',            'cmd': 'python cryptocore.py encrypt --algorithm aes --mode ecb --encrypt --key xyz --input x --output y',            'should_fail': True        },        {            'name': 'IV отвергается при шифровании',            'cmd': 'python cryptocore.py encrypt --algorithm aes --mode cbc --encrypt --key 00112233445566778899aabbccddeeff --iv 00000000000000000000000000000000 --input x --output y',            'should_fail': True        },        {            'name': 'Некорректный IV',            'cmd': 'python cryptocore.py encrypt --algorithm aes --mode cbc --decrypt --key 00112233445566778899aabbccddeeff --iv xyz --input x --output y',            'should_fail': True        }    ]        passed = 0    total = len(tests)        for test in tests:        returncode, stdout, stderr = run_command(test['cmd'])                # Проверяем, соответствует ли результат ожиданиям        if test['should_fail']:            if returncode != 0:                print(f"[+] {test['name']}")                passed += 1            else:                print(f"[-] {test['name']} (должен был завершиться с ошибкой)")        else:            if returncode == 0:                print(f"[+] {test['name']}")                passed += 1            else:                print(f"[-] {test['name']} (должен был завершиться успешно)")        print(f"\nПройдено: {passed}/{total}")    return passed == totaldef test_all_modes():    """Тестирует все режимы"""    print("\n=== Тест CryptoCore (шифрование-дешифрование для всех режимов) ===")    print("Sprint 2: ECB, CBC, CFB, OFB, CTR")    print("=" * 60)        modes = ['ecb', 'cbc', 'cfb', 'ofb', 'ctr']    results = {}        for mode in modes:        results[mode] = test_mode_roundtrip(mode)        print("\n" + "=" * 60)    print("ИТОГ ТЕСТИРОВАНИЯ (Round-trip):")    for mode, passed in results.items():        status = "[+] ПРОЙДЕН" if passed else "[-] НЕ ПРОЙДЕН"        print(f"{mode.upper()}: {status}")        # Тест валидации    cli_valid = test_cli_validation()        print("\n" + "=" * 60)    if all(results.values()) and cli_valid:        print("[+] ВСЕ ТЕСТЫ ПРОЙДЕНЫ УСПЕШНО!")        return True    else:        print("[-] НЕКОТОРЫЕ ТЕСТЫ НЕ ПРОЙДЕНЫ")        return Falseif __name__ == "__main__":    # Запускаем тесты    success = test_all_modes()        # Завершаем с соответствующим кодом    sys.exit(0 if success else 1)